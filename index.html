<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ­ê°€ìœ ì‚° ì§€ë„ ê²€ìƒ‰</title>
    
    <meta name="referrer" content="origin">
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=q9guv183ig"></script>
    
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + ë‚´ ì£¼ë³€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        body { font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; padding-bottom: 80px; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button { padding: 15px 20px; font-size: 16px; background-color: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        button:hover { background-color: #34495e; }

        /* âœ¨ ë‚´ ì£¼ë³€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .gps-btn { background-color: #27ae60; width: 100%; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .gps-btn:hover { background-color: #219150; }
        .gps-btn.active { background-color: #e67e22; }

        #result-area { display: flex; flex-direction: column; gap: 15px; }
        .item { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #eee; transition: 0.2s; }
        .item:hover { transform: translateY(-3px); border-color: #03c75a; }
        
        .item-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; color: white; background-color: #666; }
        .badge.êµ­ë³´ { background-color: #d35400; }
        .badge.ë³´ë¬¼ { background-color: #2980b9; }
        .badge.ì‚¬ì  { background-color: #27ae60; }
        
        /* âœ¨ ê±°ë¦¬ í‘œì‹œ ë±ƒì§€ */
        .dist-badge { font-size: 0.85em; color: #e67e22; font-weight: bold; margin-left: auto; display: none; }
        .dist-badge.show { display: block; }

        .item-title { font-size: 1.3em; font-weight: bold; color: #333; }
        .item-info { font-size: 0.95em; color: #7f8c8d; }

        .detail-view { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee; display: none; }
        .detail-img { max-width: 100%; border-radius: 8px; margin-bottom: 15px; }
        .detail-desc { line-height: 1.7; color: #444; margin-bottom: 15px; }
        .map-container { width: 100%; height: 350px; border-radius: 8px; border: 1px solid #ddd; margin-top: 15px; }
        .loading { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

    <h1>ğŸ›ï¸ êµ­ê°€ìœ ì‚° ì§€ë„ ê²€ìƒ‰</h1>
    
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="ë¬¸í™”ìœ ì‚° ì´ë¦„ (ì˜ˆ: ìˆ­ë¡€ë¬¸, ë¶ˆêµ­ì‚¬)" onkeypress="if(event.keyCode==13) searchHeritage()">
        <button onclick="searchHeritage()">ê²€ìƒ‰</button>
    </div>

    <!-- âœ¨ ë‚´ ì£¼ë³€ ë²„íŠ¼ ì¶”ê°€ -->
    <button onclick="sortByLocation()" class="gps-btn" id="gpsBtn">
        ğŸ“ ë‚´ ì£¼ë³€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê¸°
    </button>

    <div id="result-area"></div>

    <script>
        const PROXY_BASE = "/api/proxy?url=";
        const LIST_URL = "http://www.khs.go.kr/cha/SearchKindOpenapiList.do";
        const DETAIL_URL = "http://www.khs.go.kr/cha/SearchKindOpenapiDt.do";

        let currentItems = []; // í˜„ì¬ ê²€ìƒ‰ëœ ì•„ì´í…œë“¤ ì €ì¥ì†Œ

        async function searchHeritage() {
            const query = document.getElementById('searchInput').value;
            const resultArea = document.getElementById('result-area');
            const gpsBtn = document.getElementById('gpsBtn');
            
            if(!query) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

            resultArea.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
            gpsBtn.classList.remove('active');
            gpsBtn.innerText = "ğŸ“ ë‚´ ì£¼ë³€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê¸°";

            try {
                const targetUrl = `${LIST_URL}?ccbaMnm1=${encodeURIComponent(query)}`;
                const response = await fetch(PROXY_BASE + encodeURIComponent(targetUrl));
                const str = await response.text();
                
                const parser = new DOMParser();
                const xml = parser.parseFromString(str, "text/xml");
                const items = xml.getElementsByTagName("item");

                resultArea.innerHTML = "";
                currentItems = []; // ì´ˆê¸°í™”

                if (items.length === 0) {
                    resultArea.innerHTML = "<div class='loading'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }

                // ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•´ì„œ ì €ì¥ (ì •ë ¬ì„ ìœ„í•´)
                for (let item of items) {
                    const data = {
                        name: item.getElementsByTagName("ccbaMnm1")[0].textContent,
                        type: item.getElementsByTagName("ccmaName")[0].textContent,
                        kdcd: item.getElementsByTagName("ccbaKdcd")[0].textContent,
                        ctcd: item.getElementsByTagName("ccbaCtcd")[0].textContent,
                        asno: item.getElementsByTagName("ccbaAsno")[0].textContent,
                        lat: parseFloat(item.getElementsByTagName("latitude")[0]?.textContent || 0),
                        lng: parseFloat(item.getElementsByTagName("longitude")[0]?.textContent || 0),
                        distance: null // ê±°ë¦¬ ê³„ì‚°ìš©
                    };
                    currentItems.push(data);
                }

                renderList(currentItems); // í™”ë©´ ê·¸ë¦¬ê¸°

            } catch (error) {
                console.error(error);
                resultArea.innerHTML = "<div class='loading'>ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>";
            }
        }

        // âœ¨ í™”ë©´ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ë¶„ë¦¬ë¨)
        function renderList(items) {
            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = "";

            items.forEach(data => {
                const div = document.createElement("div");
                div.className = "item";
                
                // ê±°ë¦¬ ë±ƒì§€ í‘œì‹œ ì—¬ë¶€
                const distHtml = data.distance 
                    ? `<span class="dist-badge show">ğŸ“ ${data.distance.toFixed(1)}km</span>` 
                    : `<span class="dist-badge"></span>`;

                div.innerHTML = `
                    <div class="item-header">
                        <span class="badge ${data.type}">${data.type}</span>
                        <span class="item-title">${data.name}</span>
                        ${distHtml}
                    </div>
                    <div class="item-info">ğŸ“ ëˆŒëŸ¬ì„œ ì§€ë„ì™€ ìƒì„¸ì„¤ëª… ë³´ê¸°</div>
                    <div class="detail-view" id="detail-${data.kdcd}-${data.asno}">ë¡œë”© ì¤‘...</div>
                `;
                
                div.onclick = (e) => {
                    if(!e.target.closest('.detail-view')) {
                        toggleDetail(data.kdcd, data.ctcd, data.asno, div);
                    }
                };
                resultArea.appendChild(div);
            });
        }

        // âœ¨ ë‚´ ìœ„ì¹˜ ê¸°ë°˜ ì •ë ¬ í•¨ìˆ˜
        function sortByLocation() {
            if (currentItems.length === 0) {
                alert("ë¨¼ì € ê²€ìƒ‰ì„ í•´ì£¼ì„¸ìš”.");
                return;
            }

            const btn = document.getElementById('gpsBtn');
            btn.innerText = "ğŸ“¡ ìœ„ì¹˜ í™•ì¸ ì¤‘...";

            if (!navigator.geolocation) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const myLat = position.coords.latitude;
                    const myLng = position.coords.longitude;

                    // ê±°ë¦¬ ê³„ì‚° ë° ì •ë ¬
                    currentItems.forEach(item => {
                        if (item.lat && item.lng && item.lat !== 0) {
                            item.distance = getDistance(myLat, myLng, item.lat, item.lng);
                        } else {
                            item.distance = 99999; // ì¢Œí‘œ ì—†ëŠ” ê±´ ë§¨ ë’¤ë¡œ
                        }
                    });

                    currentItems.sort((a, b) => a.distance - b.distance);

                    renderList(currentItems); // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    btn.classList.add('active');
                    btn.innerText = "âœ… ê±°ë¦¬ìˆœ ì •ë ¬ ì™„ë£Œ";
                },
                (error) => {
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    btn.innerText = "ğŸ“ ë‚´ ì£¼ë³€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê¸°";
                }
            );
        }

        // ê±°ë¦¬ ê³„ì‚° ê³µì‹ (Haversine Formula)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        async function toggleDetail(kdcd, ctcd, asno, parentDiv) {
            const detailView = parentDiv.querySelector(".detail-view");
            
            if (detailView.style.display === "block") {
                detailView.style.display = "none";
                return;
            }
            detailView.style.display = "block";

            if (detailView.getAttribute("data-loaded") === "true") return;

            try {
                const targetUrl = `${DETAIL_URL}?ccbaKdcd=${kdcd}&ccbaCtcd=${ctcd}&ccbaAsno=${asno}`;
                const response = await fetch(PROXY_BASE + encodeURIComponent(targetUrl));
                const str = await response.text();
                
                const parser = new DOMParser();
                const xml = parser.parseFromString(str, "text/xml");

                const content = xml.getElementsByTagName("content")[0]?.textContent || "ì„¤ëª… ì—†ìŒ";
                const imgUrl = xml.getElementsByTagName("imageUrl")[0]?.textContent;
                
                const lng = xml.getElementsByTagName("longitude")[0]?.textContent;
                const lat = xml.getElementsByTagName("latitude")[0]?.textContent;

                let html = "";
                if (imgUrl) {
                    const safeImgUrl = PROXY_BASE + encodeURIComponent(imgUrl);
                    html += `<img src="${safeImgUrl}" class="detail-img"><br>`;
                }
                html += `<div class="detail-desc">${content}</div>`;

                const mapId = `map-${kdcd}-${asno}`;
                if (lat && lng && lat != "0" && lng != "0") {
                    html += `<div id="${mapId}" class="map-container"></div>`;
                } else {
                    html += `<div style="color:#888; margin-top:10px;">(ìœ„ì¹˜ ì •ë³´ê°€ ì—†ëŠ” ë¬¸í™”ìœ ì‚°ì…ë‹ˆë‹¤)</div>`;
                }

                detailView.innerHTML = html;
                detailView.setAttribute("data-loaded", "true");

                if (lat && lng && lat != "0" && lng != "0") {
                    drawNaverMap(mapId, parseFloat(lat), parseFloat(lng));
                }

            } catch (e) {
                console.error(e);
                detailView.innerHTML = "ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        function drawNaverMap(elementId, lat, lng) {
            if (typeof naver === "undefined") {
                const el = document.getElementById(elementId);
                el.innerHTML = "<div style='padding:20px; text-align:center;'>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>(URL ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”)</div>";
                return;
            }

            const mapOptions = {
                center: new naver.maps.LatLng(lat, lng),
                zoom: 16
            };
            const map = new naver.maps.Map(elementId, mapOptions);
            new naver.maps.Marker({
                position: new naver.maps.LatLng(lat, lng),
                map: map
            });
        }
    </script>
</body>
</html>