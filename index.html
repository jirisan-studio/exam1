<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ­ê°€ìœ ì‚° ì§€ë„ ê²€ìƒ‰</title>
    <!-- âœ¨ ë„¤ì´ë²„ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
    <!-- YOUR_CLIENT_ID ë¶€ë¶„ì— ë„¤ì´ë²„ í´ë¼ìš°ë“œì—ì„œ ë°œê¸‰ë°›ì€ IDë¥¼ ê¼­ ë„£ìœ¼ì„¸ìš” -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=q9guv183ig"></script>
    
    <style>
        body { font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        
        .search-box { display: flex; gap: 10px; margin-bottom: 30px; }
        input { flex: 1; padding: 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button { padding: 15px 30px; font-size: 16px; background-color: #03c75a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #02b351; }

        #result-area { display: flex; flex-direction: column; gap: 15px; }
        .item { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #eee; }
        .item:hover { transform: translateY(-3px); border-color: #03c75a; }
        .item-title { font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 8px; }
        .item-info { font-size: 0.95em; color: #7f8c8d; }

        /* ìƒì„¸ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .detail-view { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee; display: none; }
        .detail-img { max-width: 100%; border-radius: 8px; margin-bottom: 15px; }
        .detail-desc { line-height: 1.7; color: #444; margin-bottom: 15px; }
        
        /* âœ¨ ì§€ë„ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .map-container { width: 100%; height: 350px; border-radius: 8px; border: 1px solid #ddd; margin-top: 15px; }
        
        .loading { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

    <h1>ğŸ—ºï¸ êµ­ê°€ìœ ì‚° ì§€ë„ ê²€ìƒ‰</h1>
    
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="ë¬¸í™”ìœ ì‚° ì´ë¦„ (ì˜ˆ: ìˆ­ë¡€ë¬¸, ë¶ˆêµ­ì‚¬)" onkeypress="if(event.keyCode==13) searchHeritage()">
        <button onclick="searchHeritage()">ê²€ìƒ‰</button>
    </div>

    <div id="result-area"></div>

    <script>
        const PROXY_BASE = "/api/proxy?url=";
        const LIST_URL = "http://www.khs.go.kr/cha/SearchKindOpenapiList.do";
        const DETAIL_URL = "http://www.khs.go.kr/cha/SearchKindOpenapiDt.do";

        async function searchHeritage() {
            const query = document.getElementById('searchInput').value;
            const resultArea = document.getElementById('result-area');
            
            if(!query) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

            resultArea.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

            try {
                const targetUrl = `${LIST_URL}?ccbaMnm1=${encodeURIComponent(query)}`;
                const response = await fetch(PROXY_BASE + encodeURIComponent(targetUrl));
                const str = await response.text();
                
                const parser = new DOMParser();
                const xml = parser.parseFromString(str, "text/xml");
                const items = xml.getElementsByTagName("item");

                resultArea.innerHTML = "";

                if (items.length === 0) {
                    resultArea.innerHTML = "<div class='loading'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }

                for (let item of items) {
                    const name = item.getElementsByTagName("ccbaMnm1")[0].textContent;
                    const kdcd = item.getElementsByTagName("ccbaKdcd")[0].textContent;
                    const ctcd = item.getElementsByTagName("ccbaCtcd")[0].textContent;
                    const asno = item.getElementsByTagName("ccbaAsno")[0].textContent;

                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `
                        <div class="item-title">${name}</div>
                        <div class="item-info">ğŸ“ ëˆŒëŸ¬ì„œ ì§€ë„ì™€ ìƒì„¸ì„¤ëª… ë³´ê¸°</div>
                        <div class="detail-view" id="detail-${kdcd}-${asno}">ë¡œë”© ì¤‘...</div>
                    `;
                    
                    div.onclick = (e) => {
                        // ì§€ë„ë‚˜ ì´ë¯¸ì§€ë¥¼ í´ë¦­í–ˆì„ ë•ŒëŠ” ë‹«íˆì§€ ì•Šê²Œ ì²˜ë¦¬
                        if(!e.target.closest('.detail-view')) {
                            toggleDetail(kdcd, ctcd, asno, div);
                        }
                    };
                    resultArea.appendChild(div);
                }

            } catch (error) {
                console.error(error);
                resultArea.innerHTML = "<div class='loading'>ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>";
            }
        }

        async function toggleDetail(kdcd, ctcd, asno, parentDiv) {
            const detailView = parentDiv.querySelector(".detail-view");
            
            if (detailView.style.display === "block") {
                detailView.style.display = "none";
                return;
            }
            detailView.style.display = "block";

            // ì´ë¯¸ ë¡œë”©ëœ ê²½ìš° ì¬ì‹¤í–‰ ë°©ì§€ (ì§€ë„ ì¤‘ë³µ ìƒì„± ë°©ì§€)
            if (detailView.getAttribute("data-loaded") === "true") return;

            try {
                const targetUrl = `${DETAIL_URL}?ccbaKdcd=${kdcd}&ccbaCtcd=${ctcd}&ccbaAsno=${asno}`;
                const response = await fetch(PROXY_BASE + encodeURIComponent(targetUrl));
                const str = await response.text();
                
                const parser = new DOMParser();
                const xml = parser.parseFromString(str, "text/xml");

                const content = xml.getElementsByTagName("content")[0]?.textContent || "ì„¤ëª… ì—†ìŒ";
                const imgUrl = xml.getElementsByTagName("imageUrl")[0]?.textContent;
                
                // âœ¨ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸° (APIë§ˆë‹¤ íƒœê·¸ ì´ë¦„ì´ ë‹¤ë¥¼ ìˆ˜ ìˆëŠ”ë° ë³´í†µ longitude, latitudeì…ë‹ˆë‹¤)
                const lng = xml.getElementsByTagName("longitude")[0]?.textContent; // ê²½ë„ (X)
                const lat = xml.getElementsByTagName("latitude")[0]?.textContent; // ìœ„ë„ (Y)

                let html = "";
                if (imgUrl) html += `<img src="${imgUrl}" class="detail-img"><br>`;
                html += `<div class="detail-desc">${content}</div>`;

                // âœ¨ ì§€ë„ë¥¼ ë„£ì„ div ì¶”ê°€ (IDë¥¼ ìœ ë‹ˆí¬í•˜ê²Œ ìƒì„±)
                const mapId = `map-${kdcd}-${asno}`;
                if (lat && lng && lat != "0" && lng != "0") {
                    html += `<div id="${mapId}" class="map-container"></div>`;
                } else {
                    html += `<div style="color:#888; margin-top:10px;">(ìœ„ì¹˜ ì •ë³´ê°€ ì—†ëŠ” ë¬¸í™”ìœ ì‚°ì…ë‹ˆë‹¤)</div>`;
                }

                detailView.innerHTML = html;
                detailView.setAttribute("data-loaded", "true");

                // âœ¨ ì§€ë„ ê·¸ë¦¬ê¸° ì‹¤í–‰ (í™”ë©´ì— divê°€ ìƒê¸´ ì§í›„ ì‹¤í–‰í•´ì•¼ í•¨)
                if (lat && lng && lat != "0" && lng != "0") {
                    drawNaverMap(mapId, parseFloat(lat), parseFloat(lng));
                }

            } catch (e) {
                console.error(e);
                detailView.innerHTML = "ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        // âœ¨ ë„¤ì´ë²„ ì§€ë„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
        function drawNaverMap(elementId, lat, lng) {
            // ë„¤ì´ë²„ ì§€ë„ ê°ì²´ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof naver === "undefined") {
                alert("ë„¤ì´ë²„ ì§€ë„ API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                return;
            }

            const mapOptions = {
                center: new naver.maps.LatLng(lat, lng), // ì¤‘ì‹¬ ì¢Œí‘œ
                zoom: 16 // í™•ëŒ€ ë ˆë²¨
            };

            const map = new naver.maps.Map(elementId, mapOptions);

            // ë§ˆì»¤ ì°ê¸°
            new naver.maps.Marker({
                position: new naver.maps.LatLng(lat, lng),
                map: map
            });
        }
    </script>
</body>
</html>